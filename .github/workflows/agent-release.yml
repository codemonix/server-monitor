name: Agent Release (Bun)

on:
    push:
        tags:
            - 'agent-v*'

jobs:
    build-and-release:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Extract Version
              id: get_version
              run: echo "VERSION=${GITHUB_REF#refs/tags/agent-v}" >> $GITHUB_OUTPUT

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                bun-version: latest

            - name: Install Dependencies
              working-directory: ./agent
              run: bun install

            - name: Run Vitest Units
              working-directory: ./agent
              run: bun run test

            - name: Build Standalone Binary
              working-directory: ./agent
              run: |
                VERSION=${{ steps.get_version.outputs.VERSION }}

                mkdir -p bin dist

                # Injecting version into version.txt
                echo "$VERSION" >  src/version.txt
                
                # Compile using package.json build script
                bun run build:linux
                bun run build:win

            - name: Package Windows Bundle (.zip)
              working-directory: ./agent
              run: |
                VERSION=${{ steps.get_version.outputs.VERSION }}
                mkdir -p windows-bundle
                # Copy binaries, template and script
                cp bin/srm-agent.exe config.json.template scripts/register.ps1 windows-bundle/

                cd windows-bundle
                zip -r ../dist/srm-agent-v$VERSION-windows-amd64.zip .

            - name: Build Linux Package (.deb)
              working-directory: ./agent
              env:
                VERSION: ${{ steps.get_version.outputs.VERSION }}
              run: |
                # Install nfpm
                echo 'deb [trusted=yes] https://repo.goreleaser.com/apt/ /' | sudo tee /etc/apt/sources.list.d/goreleaser.list
                sudo apt-get update
                sudo apt-get install -y nfpm

                # verify installation
                nfpm --version

                # Build .deb package
                nfpm package --config nfpm.yaml --target ./dist/ --packager deb

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                name: Agent Release ${{ steps.get_version.outputs.VERSION }}
                draft: false
                prerelease: false
                files: |
                    agent/dist/*.deb
                    agent/dist/*.zip
                    agent/install.sh
                    agent/install.ps1